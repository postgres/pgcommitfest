{%extends "base.html"%}
{%load commitfest %}
{%block contents%}
 <a class="btn btn-outline-secondary" href="/open/new/">New patch</a>
 {%if cfs.in_progress%}
  <a class="btn btn-outline-secondary" href="/{{cfs.in_progress.id}}/">In Progress commitfest</a></li>
 {%endif%}
 <a class="btn btn-outline-secondary" href="/{{cfs.open.id}}/">Open commitfest</a></li>
 {%if cfs.draft%}
  <a class="btn btn-outline-secondary" href="/{{cfs.draft.id}}/">Draft commitfest</a></li>
 {%endif%}
 <button type="button" class="btn btn-outline-secondary{%if has_filter%} active{%endif%}" id="filterButton" onClick="togglePatchFilterButton('filterButton', 'collapseFilters')">Search/filter</button>
 <form method="GET" action="/search/" class="d-flex gap-2 search-bar float-end">
  <div class="form-group">
   <input type="text" class="form-control" id="searchterm" name="searchterm" placeholder="Keyword or Message-ID">
  </div>
  <button type="submit" class="btn btn-outline-secondary">Search</button>
 </form>

 <p>
  <br/>
  <b>Status summary: </b>{%for id,title,num in statussummary%}<a href="?status={{id}}">{{title}}</a>: {{num}}. {%endfor%}
 </p>


 {%include "filter_form.html" %}
 {%for p in patches %}
  {%ifchanged p.is_open%}
   {%if not forloop.first%}
    </tbody>
    </table>
   {%endif%}
   <h3>{%if user.is_authenticated%}Open patches you are subscribed to{%elif p.is_open%}Active patches in the current commitfest{%else%}Closed patches in the current commitfest{%endif%}</h3>
   <table class="table table-striped table-bordered table-hover">
    <thead>
     <tr>
      <th><a href="#" style="color:#333333;" onclick="return sortpatches(5);">Patch</a>{%if sortkey == 5%}<div style="float:right;">↓</div>{%elif sortkey == -5%}<div style="float:right;">↑</div>{%endif%}</th>
      <th><a href="#" style="color:#333333;" onclick="return sortpatches(4);">ID</a>{%if sortkey == 4%}<div style="float:right;">↓</div>{%elif sortkey == -4%}<div style="float:right;">↑</div>{%endif%}</th>
      {%if user.is_authenticated %}
       <th><a href="#" style="color:#333333;" onclick="return sortpatches(8);">CF</a>{%if sortkey == 8%}<div style="float:right;">↓</div>{%elif sortkey == -8%}<div style="float:right;">↑</div>{%endif%}</th>
      {%endif%}
      <th>Status</th>
      <th>Tags</th>
      <th>Ver</th>
      <th><a href="#" style="color:#333333;" onclick="return sortpatches(7);">CI status</a>{%if sortkey == 7%}<div style="float:right;">↓</div>{%elif sortkey == -7%}<div style="float:right;">↑</div>{%endif%}</th>
      <th><a href="#" style="color:#333333;" onclick="return sortpatches(6);">Stats</a>{%if sortkey == 6%}<div style="float:right;">↓</div>{%elif sortkey == -6%}<div style="float:right;">↑</div>{%endif%}</th>
      <th>Author</th>
      <th>Reviewers</th>
      <th>Committer</th>
      <th><a href="#" style="color:#333333;" onclick="return sortpatches(3);">Num cfs</a>{%if sortkey == 3%}<div style="float:right;">↓</div>{%elif sortkey == -3%}<div style="float:right;">↑</div>{%endif%}</th>
      <th><a href="#" style="color:#333333;" onclick="return sortpatches(2);">Latest mail</a>{%if sortkey == 2%}<div style="float:right;">↓</div>{%elif sortkey == -2%}<div style="float:right;">↑</div>{%endif%}</th>
     </tr>
    </thead>
    <tbody>
  {%endifchanged%}

  {%if grouping%}
   {%ifchanged p.topic%}
    <tr><th colspan="{%if user.is_authenticated %}13{%else%}12{%endif%}">{{p.topic}}</th></tr>
   {%endifchanged%}
  {%endif%}
  <tr>
   <td><a href="/patch/{{p.id}}/">{{p.name}}</a></td>
   <td>{{p.id}}</td>
   {%if user.is_authenticated %}
    <td><a href="/{{p.cf_id}}/"><span class="badge bg-{{p.cf_status|commitfeststatuslabel}}">{{p.cf_name}}</span></a></td>
   {%endif%}
   <td><span class="badge bg-{{p.status|patchstatuslabel}}">{{p.status|patchstatusstring}}</span></td>
   <td style="width: min-content;">
    {%for t in p.tag_ids%}
     <a href="?tag={{t}}">
      <span class="badge" style="background-color: {{all_tags|tagcolor:t}};" title="{{all_tags|tagdescription:t}}">{{all_tags|tagname:t}}</span>
     </a>
    {%endfor%}
   </td>
   <td>{%if p.targetversion%}<span class="badge bg-secondary">{{p.targetversion}}</span>{%endif%}</td>
   <td class="cfbot-summary">
    {%with p.cfbot_results as cfb%}
     {%if not cfb %}
      <span class="badge bg-secondary">Not processed</span>
     {%elif p.needs_rebase_since %}
      <a href="{{cfb.apply_url}}" title="View git apply logs. Needs rebase {% cfsince p.needs_rebase_since %}. {%if p.failing_since and p.failing_since != p.needs_rebase_since %}Failing {% cfsince p.failing_since %}.{%endif%}">
       <span class="badge bg-warning">Needs rebase!</span>
      </a>
     {%else%}
      <a href="https://github.com/postgresql-cfbot/postgresql/compare/cf/{{p.id}}~1...cf/{{p.id}}" title="View last patch set on GitHub"><img class="github-logo" src="/media/commitfest/github-mark.svg"/></a>
      <a href="https://cirrus-ci.com/github/postgresql-cfbot/postgresql/cf%2F{{p.id}}"
         title="View CI history. {%if p.failing_since%}Failing {% cfsince p.failing_since %}. {%endif%}{%if cfb.failed_task_names %}Failed jobs: {{cfb.failed_task_names}}{%endif%}">
       {%if cfb.failed > 0 or cfb.branch_status == 'failed' or cfb.branch_status == 'timeout' %}
        <img src="/media/commitfest/new_failure.svg"/>
       {%elif cfb.completed < cfb.total  %}
        <img src="/media/commitfest/running.svg"/>
       {%else%}
        <img src="/media/commitfest/new_success.svg"/>
       {%endif%}
       <span class="run-counters">
        {{cfb.completed}}/{{cfb.total}}
       </span>
      </a>
     {%endif%}
     </td>
     <td>
      {%if cfb and cfb.all_additions is not none %}
       <span class="additions">+{{ cfb.all_additions }}</span><span class="deletions">&#8722;{{ cfb.all_deletions }}</span>
      {%endif%}
     </td>
    {%endwith%}
    <td>{{p.author_names|default:''}}</td>
    <td>{{p.reviewer_names|default:''}}</td>
    <td>{{p.committer|default:''}}</td>
    <td>{{p.num_cfs}}</td>
    <td style="white-space: nowrap;" title="{{p.lastmail}}">{%if p.lastmail and userprofile.show_relative_timestamps %}{% cfwhen p.lastmail %}{%elif p.lastmail %}{{p.lastmail|date:"Y-m-d"}}<br/>{{p.lastmail|date:"H:i"}}{%endif%}</td>
   </tr>
   {%if forloop.last%}
    </tbody>
    </table>
   {%endif%}
 {%endfor%}
{%endblock%}
{%block morescript%}
 {%include "selectize_js.html" %}
{%endblock%}
