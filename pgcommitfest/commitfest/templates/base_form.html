{%extends "base.html"%}
{%load commitfest%}

{%block contents%}
 <form class="form-horizontal {{extraformclass}}" method="POST" action=".">{%csrf_token%}
  {%if form.errors%}
   <div class="alert">Please correct the errors below, and re-submit the form.</div>
  {%endif%}
  {%if form.non_field_errors%}
   <div class="alert alert-danger">{{form.non_field_errors}}</div>
  {%endif%}
  {%if note%}
   <div class="alert alert-info">{{note|safe}}</div>
  {%endif%}
  {%for field in form%}
   {%if not field.is_hidden%}
    {%if field.name == 'tags' and form.checkbox_tags %}
     {# Render the tags field with checkbox shortcuts #}
     <div class="form-group">
      <label class="control-label">Tags</label>
      <div class="col-lg-12 controls">
       {# Checkbox shortcuts for common tags #}
       <div class="btn-group flex-wrap tag-checkbox-group mb-2" role="group" aria-label="Quick tag selection">
        <button type="button" class="btn btn-sm btn-outline-secondary" disabled>Shortcuts:</button>
        {%for tag in form.checkbox_tags%}
         <input type="checkbox" class="btn-check tag-shortcut-checkbox" data-tag-id="{{tag.id}}" data-tag-name="{{tag.name}}" id="tag_shortcut_{{tag.id}}" autocomplete="off">
         <label class="btn btn-sm btn-outline-primary d-inline-flex align-items-center" for="tag_shortcut_{{tag.id}}"><span class="tag-color" style="background-color: {{tag.color}}; width: 10px; height: 10px; border-radius: 2px; margin-right: 4px; margin-top: 1px;"></span>{{tag.name}}</label>
        {%endfor%}
       </div>
       {# The actual selectize field for all tags #}
       {{field}}
       {%if field.help_text%}<br/>{{field.help_text|safe}}{%endif%}
       {# "No tags apply" checkbox below the selectize (only for new patches) #}
       {%if form.no_tags_apply %}
       <div class="form-check mt-2">
        <input type="checkbox" class="form-check-input" name="no_tags_apply" id="id_no_tags_apply" {% if form.no_tags_apply.value %}checked{% endif %}>
        <label class="form-check-label" for="id_no_tags_apply">{{form.no_tags_apply.label}}</label>
        {%if form.no_tags_apply.help_text%}<small class="form-text text-muted d-block">{{form.no_tags_apply.help_text}}</small>{%endif%}
       </div>
       {%endif%}
      </div>
     </div>
    {%elif field.name == 'no_tags_apply' %}
     {# Skip - rendered as part of the tags group above #}
    {%else%}
    <div class="form-group">
     {{field|label_class:"control-label"}}
     <div class="col-lg-12 controls">
      {%if field.errors %}
       {%for e in field.errors%}
        <div class="alert alert-danger">{{e}}</div>
       {%endfor%}
      {%endif%}
      {%if field.name|slice:":7" == 'review_' %}
       {%for choice in field %}
        <div class="form-check form-check-inline">
         <input type="checkbox" class="form-check-input" name="{{field.name}}" value="{{choice.data.value}}" id="{{choice.id_for_label}}" {% if choice.data.selected %}checked{% endif %}>
         <label class="form-check-label" for="{{choice.id_for_label}}">{{choice.choice_label}}</label>
        </div>
       {%endfor%}
      {%elif not field.name in form.selectize_fields%}{{field|field_class:"form-control"}}{%else%}{{field}}{%endif%}
      {%if field.help_text%}<br/>{{field.help_text|safe}}{%endif%}</div>
    </div>
    {%endif%}
   {%else%}
    {{field}}
   {%endif%}
  {%endfor%}
  <div class="form-group">
   <div class="col-lg-12">
    <input type="submit" class="btn btn-primary" value="{{savebutton|default:"Save"}}">
   </div>
  </div>
 </form>

 {%if threadbrowse %}
  {%include "thread_attach.inc" %}
 {%endif%}

 {%if user.is_staff%}
  <div class="modal fade" id="searchUserModal" role="dialog">
   <div class="modal-dialog modal-lg">
    <div class="modal-content">
     <div class="modal-header">
      <h3 class="modal-title">Search user</h3>
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
     </div>
     <div class="modal-body">
      <form class="d-flex gap-2" style="margin-bottom: 5px;">
       <div class="input-group">
        <input id="searchUserSearchField" type="text" class="form-control" autocomplete="off">
        <button id="searchUserSearchButton" onclick="return findUsers()" class="btn btn-secondary">Search</button>
       </div>
      </form>
      <div>Search for users above and then pick one in the list below:</div>
      <div id="searchUserListWrap">
       <select id="searchUserList" size="6" style="width:100%;" onchange="searchUserListChanged()"></select>
      </div>
     </div>
     <div class="modal-footer">
      <a href="#" class="btn btn-secondary" data-bs-dismiss="modal">Close</a>
      <a href="#" id="doSelectUserButton" class="btn btn-primary disabled">Add user to system</a>
     </div>
    </div>
   </div>
  </div>
 {%endif%}
{%endblock%}

{%block morescript%}

 {%include "selectize_js.html" %}
 <script>
  {%if user.is_staff%}
   $('.selectize-control.add-user-picker').after(
    $('<a href="#" class="btn btn-secondary btn-sm">Import user not listed</a>').click(function () {
     search_and_store_user();
    })
   );

   $('#searchUserModal').on('shown.bs.modal', function() {
    $('#searchUserSearchField').focus();
   });
  {%endif%}

  // Tag shortcut checkbox synchronization with selectize
  (function() {
   var $tagsSelect = $('#id_tags');
   if (!$tagsSelect.length || !$tagsSelect[0].selectize) return;

   var selectize = $tagsSelect[0].selectize;
   var $checkboxes = $('.tag-shortcut-checkbox');
   var $noTagsCheckbox = $('#id_no_tags_apply');

   // Initialize checkbox state from current selectize values
   function syncCheckboxesFromSelectize() {
    var selectedIds = selectize.getValue();
    if (typeof selectedIds === 'string') {
     selectedIds = selectedIds ? selectedIds.split(',') : [];
    }
    selectedIds = selectedIds.map(function(id) { return String(id); });

    $checkboxes.each(function() {
     var tagId = String($(this).data('tag-id'));
     $(this).prop('checked', selectedIds.indexOf(tagId) !== -1);
    });

    // Uncheck "no tags apply" if any tags are selected
    if ($noTagsCheckbox.length && selectedIds.length > 0) {
     $noTagsCheckbox.prop('checked', false);
    }
   }

   // Sync on selectize change
   selectize.on('change', syncCheckboxesFromSelectize);

   // Handle checkbox clicks
   $checkboxes.on('change', function() {
    var tagId = String($(this).data('tag-id'));
    if ($(this).is(':checked')) {
     selectize.addItem(tagId, true);
     if ($noTagsCheckbox.length) {
      $noTagsCheckbox.prop('checked', false);
     }
    } else {
     selectize.removeItem(tagId, true);
    }
   });

   // Handle "no tags apply" checkbox (only exists for new patches)
   if ($noTagsCheckbox.length) {
    $noTagsCheckbox.on('change', function() {
     if ($(this).is(':checked')) {
      selectize.clear(true);
      $checkboxes.prop('checked', false);
     }
    });
   }

   // Initial sync
   syncCheckboxesFromSelectize();
  })();
 </script>
{%endblock%}
